<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Colec»õii ‚Äî Biblioteca pentru to»õi</title>
  <meta name="description" content="ListeazƒÉ colec»õii, √Ænscriere, pƒÉrƒÉsire »ôi ata»ôeazƒÉ/deta»ôeazƒÉ bibliotecile tale la colec»õii. Afi»ôeazƒÉ membri & biblioteci (collections.details) »ôi permite creare self-service (collections.create)." />
  <style>
    :root{
      --bg:#0f172a;--fg:#e2e8f0;--muted:#94a3b8;--card:#111827;--border:#1f2937;
      --accent:#22c55e;--accent2:#3b82f6;--danger:#ef4444;--warn:#f59e0b
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    a{color:var(--accent2);text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .title{font-weight:600;letter-spacing:.2px}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);padding:6px 10px;border-radius:999px;font-size:.85rem;color:var(--muted)}
    .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .badge.ok .dot{background:var(--accent)} .badge.err .dot{background:var(--danger)}

    .card{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:16px;margin-top:14px}
    .card h2{margin:0 0 10px;font-size:1.05rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--fg);font-size:.95rem;outline:none}
    textarea{min-height:90px;resize:vertical}
    button{cursor:pointer;background:#0a0f1e}
    button.primary{background:var(--accent2);border-color:var(--accent2);color:#fff}
    button.ghost{background:transparent}
    button.warn{background:#231a0a;border-color:#3b2a0b}
    button.danger{background:#1f0a0a;border-color:#3a1111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:.9rem;color:var(--muted)}
    .msg{margin-top:12px;padding:10px 12px;border-radius:10px;background:#0b1220;border:1px solid var(--border);color:var(--muted)}
    .msg.ok{color:#c8facc;border-color:#134e26;background:#07140d}
    .msg.err{color:#fecaca;border-color:#4c1d1d;background:#140707}

    .pill{padding:8px 12px;border:1px solid var(--border);background:#0b1220;border-radius:999px}
    .cols{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:1000px){.cols{grid-template-columns:1fr}}
    .libList{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0b1220;max-height:260px;overflow:auto}
    .libItem{display:flex;align-items:center;gap:8px;padding:6px 4px;border-bottom:1px solid #0f1a2a}
    .libItem:last-child{border-bottom:none}
    .libItem code{opacity:.8}

    .colCard{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px;background:#0b1220}
    .colHead{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .colTitle{font-weight:600}
    .chips{display:flex;gap:8px;flex-wrap:wrap}

    /* Detalii colec»õie */
    .details{margin-top:10px;border-top:1px dashed #1f2a3a;padding-top:10px}
    .section{margin-top:8px}
    .miniTable{width:100%;border-collapse:separate;border-spacing:0}
    .miniTable th,.miniTable td{padding:8px;border-bottom:1px solid #1f2937;text-align:left;vertical-align:top}
    .tag{display:inline-block;padding:2px 6px;border:1px solid var(--border);border-radius:999px;font-size:.8rem;color:var(--muted);background:#0a0f1e}
    .sr{position:absolute;left:-9999px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">üóÇÔ∏è Colec»õii ‚Äî <span id="uiVersion"></span></div>
      <div class="badge" id="cfgBadge"><span class="dot"></span><span id="cfgText">Config nevalidat</span></div>
    </header>

    <section class="card">
      <h2>Bibliotecile tale (owner) ‚Äî pentru ata»ôare la colec»õii</h2>
      <div class="hint">BifeazƒÉ bibliotecile pe care vrei sƒÉ le ata»ôezi/deta»ôezi la colec»õiile √Æn care e»ôti owner.</div>
      <div id="libsOwned" class="libList"></div>
      <div class="row" style="margin-top:8px">
        <button id="selectAll" class="ghost">SelecteazƒÉ toate</button>
        <button id="clearSel" class="ghost">Gole»ôte selec»õia</button>
        <a class="pill" href="libraries.html">üîß AdministreazƒÉ biblioteci</a>
        <a class="pill" href="index.html">‚üµ √énapoi la Hub</a>
      </div>
    </section>

    <section class="card">
      <h2>√énscriere √Æntr-o colec»õie (dupƒÉ ID)</h2>
      <div class="grid">
        <div>
          <label class="sr" for="joinId">Collection ID</label>
          <input id="joinId" type="text" placeholder="ex: 7b9d3c2d-..." />
        </div>
        <div>
          <button id="btnJoin" class="primary">√énscrie-mƒÉ</button>
        </div>
      </div>
      <div id="joinMsg" class="msg" hidden></div>
    </section>

    <section class="card">
      <h2>Colec»õiile mele</h2>
      <div class="row">
        <span class="hint">Sunt listate colec»õiile unde e»ôti membru. ApasƒÉ ‚ÄûDetalii‚Äù pentru membri & biblioteci.</span>
        <button id="refresh" class="ghost">Re√ÆncarcƒÉ</button>
      </div>
      <div id="colsWrap"></div>
      <div id="listMsg" class="msg" hidden></div>
    </section>

    <section class="card">
      <h2>CreeazƒÉ colec»õie</h2>
      <div class="grid">
        <div>
          <label class="sr" for="newName">Nume</label>
          <input id="newName" type="text" placeholder="Ex: Colec»õia cartierului" />
        </div>
        <div>
          <label class="sr" for="newDesc">Descriere</label>
          <input id="newDesc" type="text" placeholder="ScurtƒÉ descriere" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnCreateSelf" class="primary">CreeazƒÉ (self-service)</button>
        <button id="btnCreateAdmin" class="ghost">CreeazƒÉ (admin)</button>
        <span class="hint">‚ÄûSelf-service‚Äù folose»ôte <code>collections.create</code>. Butonul ‚Äûadmin‚Äù folose»ôte <code>admin.createCollection</code>.</span>
      </div>
      <div id="createMsg" class="msg" hidden></div>
    </section>
  </div>

  <script>
    const UI_VERSION = '0.1.1';
    const LS_KEYS = {
      url:'BPT_SCRIPT_URL',
      secret:'BPT_SECRET'
    };

    const els = {
      uiVersion: document.getElementById('uiVersion'),
      cfgBadge: document.getElementById('cfgBadge'),
      cfgText: document.getElementById('cfgText'),

      libsOwned: document.getElementById('libsOwned'),
      selectAll: document.getElementById('selectAll'),
      clearSel: document.getElementById('clearSel'),

      joinId: document.getElementById('joinId'),
      btnJoin: document.getElementById('btnJoin'),
      joinMsg: document.getElementById('joinMsg'),

      colsWrap: document.getElementById('colsWrap'),
      listMsg: document.getElementById('listMsg'),
      refresh: document.getElementById('refresh'),

      newName: document.getElementById('newName'),
      newDesc: document.getElementById('newDesc'),
      btnCreateSelf: document.getElementById('btnCreateSelf'),
      btnCreateAdmin: document.getElementById('btnCreateAdmin'),
      createMsg: document.getElementById('createMsg'),
    };

    els.uiVersion.textContent = `UI v${UI_VERSION}`;

    function setBadge(state, text){
      els.cfgBadge.classList.remove('ok','err');
      if(state==='ok') els.cfgBadge.classList.add('ok');
      if(state==='err') els.cfgBadge.classList.add('err');
      els.cfgText.textContent = text;
    }
    function showMsg(el, kind, text){
      el.hidden = false; el.classList.remove('ok','err');
      if(kind) el.classList.add(kind);
      el.textContent = text;
    }
    function clearMsg(el){ el.hidden = true; el.textContent=''; el.classList.remove('ok','err'); }

    function cfg(){
      return {
        url: localStorage.getItem(LS_KEYS.url)||'',
        secret: localStorage.getItem(LS_KEYS.secret)||'',
      };
    }
    async function apiCall(op, params={}){
      const c = cfg();
      if(!c.url || !c.secret) throw new Error('config_missing');
      const res = await fetch(c.url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token: c.secret, op, params })
      });
      const data = await res.json().catch(()=> ({}));
      if(!data || data.ok!==true){
        const code = data && data.error ? data.error : 'unknown_error';
        const err = new Error(code);
        err._server = data;
        throw err;
      }
      return data.data;
    }

    // ‚Äî‚Äî Biblioteci de»õinute (owner) ‚Äî selec»õie pentru attach/detach
    let ownedLibs = [];
    function renderOwnedLibs(){
      els.libsOwned.innerHTML = '';
      if(ownedLibs.length===0){
        els.libsOwned.innerHTML = '<div class="hint" style="padding:6px">Nu e»ôti owner pe nicio bibliotecƒÉ (sau backend nu a returnat).</div>';
        return;
      }
      for(const lib of ownedLibs){
        const row = document.createElement('div');
        row.className = 'libItem';
        row.innerHTML = `
          <label class="row"><input type="checkbox" class="libCb" data-id="${lib.libraryId}"/> ${lib.name} <code>${lib.libraryId}</code></label>
        `;
        els.libsOwned.appendChild(row);
      }
    }
    function selectedOwnedLibIds(){
      return Array.from(document.querySelectorAll('.libCb:checked')).map(cb => cb.dataset.id);
    }

    // ‚Äî‚Äî Colec»õii
    let collections = [];
    function renderCollections(){
      els.colsWrap.innerHTML = '';
      if(collections.length===0){
        els.colsWrap.innerHTML = '<div class="hint">Nu ai nicio colec»õie √Æn listƒÉ. √éncearcƒÉ Join dupƒÉ ID sau creeazƒÉ una.</div>';
        return;
      }
      for(const c of collections){
        els.colsWrap.appendChild(renderCollectionCard(c));
      }
    }

    function renderCollectionCard(col){
      const div = document.createElement('div');
      div.className = 'colCard';
      div.dataset.id = col.collectionId;

      const head = document.createElement('div');
      head.className = 'colHead';

      const title = document.createElement('div');
      title.className = 'colTitle';
      title.textContent = `${col.name || '(fƒÉrƒÉ nume)'}`;
      head.appendChild(title);

      const chips = document.createElement('div');
      chips.className = 'chips';
      const chipId = document.createElement('span'); chipId.className = 'pill'; chipId.textContent = (col.collectionId || '‚Äî');
      const chipRole = document.createElement('span'); chipRole.className = 'pill'; chipRole.textContent = 'rol: ' + (col.role || '‚Äî');
      chips.appendChild(chipId); chips.appendChild(chipRole);
      head.appendChild(chips);

      div.appendChild(head);

      // Ac»õiuni membership
      const actions = document.createElement('div');
      actions.className = 'row';
      actions.style.marginTop = '8px';
      const btnDetails = document.createElement('button'); btnDetails.className = 'ghost'; btnDetails.textContent = 'Detalii';
      const btnLeave = document.createElement('button'); btnLeave.className = 'ghost'; btnLeave.textContent = (col.role || '').toLowerCase()==='owner' ? 'PƒÉrƒÉse»ôte (poate e»ôua pentru owner)' : 'PƒÉrƒÉse»ôte';
      actions.appendChild(btnDetails);
      actions.appendChild(btnLeave);
      div.appendChild(actions);

      btnLeave.addEventListener('click', async ()=>{
        try{
          await apiCall('collections.leave', { collectionId: col.collectionId });
          showMsg(els.listMsg,'ok','Ai pƒÉrƒÉsit colec»õia.');
          await loadAll();
        }catch(e){
          showMsg(els.listMsg,'err','Eroare la pƒÉrƒÉsire: ' + e.message);
        }
      });

      // Attach/detach din selec»õia de sus
      const attachRow = document.createElement('div');
      attachRow.className = 'row';
      attachRow.style.marginTop = '8px';
      attachRow.innerHTML = `
        <button class="primary" data-act="attach">Ata»ôeazƒÉ selec»õia</button>
        <button class="warn" data-act="detach">Deta»ôeazƒÉ selec»õia</button>
        <span class="hint">AfecteazƒÉ bibliotecile selectate sus (unde e»ôti owner).</span>
      `;
      const btnAttach = attachRow.querySelector('[data-act="attach"]');
      const btnDetach = attachRow.querySelector('[data-act="detach"]');
      div.appendChild(attachRow);

      btnAttach.addEventListener('click', async ()=>{
        const ids = selectedOwnedLibIds();
        if(ids.length===0){ showMsg(els.listMsg,'', 'SelecteazƒÉ √Ænt√¢i bibliotecile de ata»ôat.'); return; }
        let ok=0, fail=0;
        for(const id of ids){
          try{ await apiCall('collections.addLibrary', { collectionId: col.collectionId, libraryId: id }); ok++; }
          catch(e){ fail++; }
        }
        showMsg(els.listMsg, fail? 'err':'ok', `Ata»ôare: OK=${ok}, erori=${fail}.`);
        // re√ÆncarcƒÉ detalii dacƒÉ sunt deschise
        if(detailsWrap.dataset.loaded==='1') await loadDetails(col.collectionId, detailsWrap);
      });

      btnDetach.addEventListener('click', async ()=>{
        const ids = selectedOwnedLibIds();
        if(ids.length===0){ showMsg(els.listMsg,'', 'SelecteazƒÉ √Ænt√¢i bibliotecile de deta»ôat.'); return; }
        let ok=0, fail=0;
        for(const id of ids){
          try{ await apiCall('collections.removeLibrary', { collectionId: col.collectionId, libraryId: id }); ok++; }
          catch(e){ fail++; }
        }
        showMsg(els.listMsg, fail? 'err':'ok', `Deta»ôare: OK=${ok}, erori=${fail}.`);
        if(detailsWrap.dataset.loaded==='1') await loadDetails(col.collectionId, detailsWrap);
      });

      // Detalii (lazy)
      const detailsWrap = document.createElement('div');
      detailsWrap.className = 'details';
      detailsWrap.style.display = 'none';
      detailsWrap.innerHTML = '<div class="hint">ApasƒÉ ‚ÄûDetalii‚Äù pentru a √ÆncƒÉrca informa»õiile.</div>';
      div.appendChild(detailsWrap);

      btnDetails.addEventListener('click', async ()=>{
        detailsWrap.style.display = detailsWrap.style.display === 'none' ? '' : 'none';
        if(detailsWrap.style.display !== 'none' && detailsWrap.dataset.loaded !== '1'){
          await loadDetails(col.collectionId, detailsWrap);
        }
      });

      return div;
    }

    async function loadDetails(collectionId, container){
      container.dataset.loaded = '0';
      container.innerHTML = '<div class="hint">Se √ÆncarcƒÉ detaliile‚Ä¶</div>';
      try{
        const data = await apiCall('collections.details', { collectionId });
        const { collection, role, members, libraries } = data;

        const top = document.createElement('div');
        top.className = 'section';
        top.innerHTML = `
          <div class="row">
            <span class="tag">rol: ${role}</span>
            <span class="tag">createdBy: ${collection.createdBy || '‚Äî'}</span>
            <span class="tag">createdAt: ${collection.createdAt || '‚Äî'}</span>
            <button class="ghost" id="btnRefreshDetails">Re√ÆncarcƒÉ detalii</button>
          </div>
          <div class="hint" style="margin-top:6px">${collection.description || ''}</div>
        `;

        // Members table
        const memSec = document.createElement('div');
        memSec.className = 'section';
        const memRows = (members || []).map(m => `
          <tr><td>${m.userId || ''}</td><td>${m.role || ''}</td><td>${m.joinedAt || ''}</td></tr>
        `).join('');
        memSec.innerHTML = `
          <h3 style="margin:6px 0">Membri</h3>
          <table class="miniTable">
            <thead><tr><th>User</th><th>Rol</th><th>Din</th></tr></thead>
            <tbody>${memRows || '<tr><td colspan="3" class="hint">‚Äî</td></tr>'}</tbody>
          </table>
        `;

        // Libraries table (detach individual dacƒÉ e»ôti owner)
        const libSec = document.createElement('div');
        libSec.className = 'section';
        const canManage = String(role).toLowerCase() === 'owner';
        const libRows = (libraries || []).map(lib => `
          <tr>
            <td>${lib.name || ''}</td>
            <td><code>${lib.libraryId || ''}</code></td>
            <td>${lib.ownerUser || ''}</td>
            <td>${lib.visibility || ''}</td>
            <td>${canManage ? `<button class="warn" data-lib="${lib.libraryId}">Deta»ôeazƒÉ</button>` : ''}</td>
          </tr>
        `).join('');
        libSec.innerHTML = `
          <h3 style="margin:6px 0">Biblioteci √Æn colec»õie</h3>
          <table class="miniTable">
            <thead><tr><th>Nume</th><th>libraryId</th><th>Owner</th><th>Vizibilitate</th><th>Ac»õiuni</th></tr></thead>
            <tbody>${libRows || '<tr><td colspan="5" class="hint">‚Äî</td></tr>'}</tbody>
          </table>
        `;

        container.innerHTML = '';
        container.appendChild(top);
        container.appendChild(memSec);
        container.appendChild(libSec);
        container.dataset.loaded = '1';

        // wire refresh + detach individual
        top.querySelector('#btnRefreshDetails').addEventListener('click', async ()=>{
          await loadDetails(collectionId, container);
        });
        if(canManage){
          container.querySelectorAll('button.warn[data-lib]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const libId = btn.getAttribute('data-lib');
              try{
                await apiCall('collections.removeLibrary', { collectionId, libraryId: libId });
                showMsg(els.listMsg,'ok','Biblioteca a fost deta»ôatƒÉ.');
                await loadDetails(collectionId, container);
              }catch(e){
                showMsg(els.listMsg,'err','Nu am putut deta»ôa: ' + e.message);
              }
            });
          });
        }
      }catch(e){
        container.innerHTML = '<div class="msg err">Eroare la √ÆncƒÉrcarea detaliilor: ' + e.message + '</div>';
      }
    }

    // ‚Äî‚Äî Loaders
    async function loadOwnedLibs(){
      ownedLibs = [];
      els.libsOwned.innerHTML = '<div class="hint" style="padding:6px">Se √ÆncarcƒÉ bibliotecile‚Ä¶</div>';
      try{
        const data = await apiCall('libs.list');
        const all = data.libraries || [];
        ownedLibs = all.filter(x => String(x.permission).toLowerCase()==='owner')
                       .map(x => ({ libraryId: x.libraryId, name: x.name }));
        renderOwnedLibs();
      }catch(e){
        els.libsOwned.innerHTML = '';
        showMsg(els.listMsg,'err','Nu pot √ÆncƒÉrca bibliotecile: ' + e.message);
      }
    }

    async function loadCollections(){
      clearMsg(els.listMsg);
      els.colsWrap.innerHTML = '<div class="hint">Se √ÆncarcƒÉ colec»õiile‚Ä¶</div>';
      try{
        const data = await apiCall('collections.list', {});
        collections = data.collections || [];
        collections.sort((a,b)=> String(a.name||'').localeCompare(String(b.name||''),'ro'));
        renderCollections();
      }catch(e){
        els.colsWrap.innerHTML = '';
        showMsg(els.listMsg,'err','Nu pot √ÆncƒÉrca colec»õiile: ' + e.message);
      }
    }

    async function loadAll(){
      await loadOwnedLibs();
      await loadCollections();
    }

    // ‚Äî‚Äî Actions (join/create)
    els.btnJoin.addEventListener('click', async ()=>{
      clearMsg(els.joinMsg);
      const id = els.joinId.value.trim();
      if(!id){ showMsg(els.joinMsg,'err','Introdu un Collection ID.'); return; }
      try{
        await apiCall('collections.join', { collectionId: id });
        showMsg(els.joinMsg,'ok','Te-ai √Ænscris √Æn colec»õie.');
        els.joinId.value = '';
        await loadCollections();
      }catch(e){
        showMsg(els.joinMsg,'err','Eroare la √Ænscriere: ' + e.message);
      }
    });

    els.btnCreateSelf.addEventListener('click', async ()=>{
      clearMsg(els.createMsg);
      const name = els.newName.value.trim();
      const description = els.newDesc.value.trim();
      if(!name){ showMsg(els.createMsg,'err','Introdu un nume pentru colec»õie.'); return; }
      // ata»ôeazƒÉ op»õional bibliotecile bifate
      const libs = selectedOwnedLibIds();
      try{
        const data = await apiCall('collections.create', { name, description, libraries: libs });
        showMsg(els.createMsg,'ok','Colec»õie creatƒÉ. ID: ' + data.collectionId);
        els.newName.value=''; els.newDesc.value='';
        // goli»õi selec»õia bibliotecilor
        document.querySelectorAll('.libCb').forEach(cb => cb.checked = false);
        await loadCollections();
      }catch(e){
        showMsg(els.createMsg,'err','Nu s-a putut crea colec»õia: ' + e.message);
      }
    });

    els.btnCreateAdmin.addEventListener('click', async ()=>{
      clearMsg(els.createMsg);
      const name = els.newName.value.trim();
      const description = els.newDesc.value.trim();
      if(!name){ showMsg(els.createMsg,'err','Introdu un nume pentru colec»õie.'); return; }
      try{
        const data = await apiCall('admin.createCollection', { name, description });
        showMsg(els.createMsg,'ok','Colec»õie creatƒÉ (admin). ID: ' + data.collectionId);
        els.newName.value=''; els.newDesc.value='';
        await loadCollections();
      }catch(e){
        showMsg(els.createMsg,'err','Eroare la creare (admin): ' + e.message);
      }
    });

    els.refresh.addEventListener('click', loadAll);
    els.selectAll.addEventListener('click', ()=>{ document.querySelectorAll('.libCb').forEach(cb => cb.checked = true); });
    els.clearSel.addEventListener('click', ()=>{ document.querySelectorAll('.libCb').forEach(cb => cb.checked = false); });

    // ‚Äî‚Äî Init
    (async function init(){
      const c = cfg();
      const ok = !!(c.url && c.secret);
      setBadge(ok ? 'ok' : '', ok ? 'Config OK' : 'Config nevalidat');
      if(!ok){
        showMsg(els.listMsg,'err','CompleteazƒÉ √Ænt√¢i SetƒÉrile (Script URL + Secret).');
        return;
      }
      await loadAll();
    })();
  </script>
</body>
</html>
